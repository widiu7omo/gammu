os:
  - linux
  - osx
language: cpp
compiler:
  - gcc
  - clang
env:
  matrix:
    - ARGS=""
  global:
    - CTEST_OUTPUT_ON_FAILURE=1
    - TESTARGS="-DMYSQL_TESTING=on -DPSQL_TESTING=ON -DMYSQL_USER=root -DPSQL_USER=postgres -DPSQL_PASSWORD="
before_script:
  - if [ $TRAVIS_OS_NAME = linux ] ; then psql -c 'create database smsd;' -U postgres ; fi
  - if [ $TRAVIS_OS_NAME = linux ] ; then mysql -uroot -e "create database smsd;" ; fi
  - if [ $TRAVIS_OS_NAME = linux ] ; then mysql -uroot -e "SET PASSWORD = PASSWORD('smsd')" ; fi
  - if [ $TRAVIS_OS_NAME != linux ] ; then export TESTARGS= ; fi
  - mkdir _build
  - cd _build
  - ln -s ../codecov.yml .
script:
  - cmake .. -DCMAKE_C_COMPILER=$CC -DENABLE_COVERAGE=ON -DCMAKE_BUILD_TYPE=Continuous -DONLINE_TESTING=ON $TESTARGS $ARGS
  - make || travis_terminate 1
  - make test
after_success:
  - make gcov
  - bash <(curl -s https://codecov.io/bash) -X gcov -F $TRAVIS_OS_NAME
  - cd ~/build/widiu7omo/gammu/
  - zip -9 -r ${TRAVIS_BUILD_DIR}${REPO}-${BUILD_ENV}-${TRAVIS_TAG}-${TRAVIS_BUILD_NUMBER}.zip ./*
before_deploy:
- git config --local user.name "widiu7omo"
- git config --local user.email "widiu7omo@gmail.com"
- export TRAVIS_TAG=${TRAVIS_TAG:-$(date +'%Y%m%d%H%M%S')-$(git log --format=%h -1)}
- git tag $TRAVIS_TAG
deploy:
  provider: releases
  draft: true
  skip_cleanup: true
  api_key:
    secure: n2wdyI7M67hg3D2pfiuJCQwAItTJNeM7Y8oa1PUshMPoSPQlp3C7T3Jt5QsAcaR5cNSMP+udVEBrBpBvwUa401CoTnGZtG5gF7XptnhITsflmxBL4ZLQ+hVfSlrEY94wc0aJmwiqNrESDyYF4VOoy/zxep6q4Hh1qrU4XD+SeSwIpY72G53Woqdp15IMiwBaiYqYJpqORWsDNz2I3HkNJ1aBw6Z3j7NJxA3N0gU3G/gIEsCx3EfS6HsWprrDYxnZDv3iK5GM8GkxGiNb0Ij/uESLQmU0Ttbmc3NRLq2EVUvJL2N0KpmwcUTXt55dWfFVsh7Gc3Q3qoPL1jdUcScnt3OCUTk3haNjdBWpIDfy9lRACLCJjm/cUAsr8Q9cTK1gcI+TjNUrPViBC/Ct0DV+ucg0Fl5eZg78DWiHVsmE1P7vVpM5nKVts2W/I5Hl5uVMwy4zejRej+yrRhQr68EYd5OxUc9FiRy1bou4FivFjr41H8enap+80bZ6LftsrVT8ujHfwqsVlemVa9fQQWHrBplqy1fH6RAc1Yv7k3ISUV4IMS6EEI7OBL+j9jrNX3+zO5falLo0oRBOTtDKNd0K63EV8f1uVeOO5SmxwnzdsZxL/OeqXtfRudBMWbSE4vmfMyvU3joKXbrdWhkAMoHjCITWJa5Ht+FCI3aKWqolkdc=
  file: 
  - ${TRAVIS_BUILD_DIR}${REPO}-${BUILD_ENV}-${TRAVIS_TAG}-${TRAVIS_BUILD_NUMBER}.zip
  on:
    repo: widiu7omo/gammu
    branch: master
addons:
  apt:
    packages:
    - libbluetooth-dev
    - libusb-1.0-0-dev
    - libgudev-1.0-dev
    - unixodbc-dev
    - libdbi-dev
    - libdbd-sqlite3
    - libdbd-mysql
    - libdbd-pgsql
    - cmake
    - cmake-data
matrix:
  exclude:
    - os: osx
      compiler: gcc
  include:
    - os: linux
      compiler: gcc
      env: ARGS="-DENABLE_GETOPT=OFF"
    - os: linux
      compiler: gcc
      env: ARGS="-DUSE_WCHAR_T=OFF"
services:
  - mysql
  - postgresql
